<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Astroid-Like Game</title>
</head>
<script src="/socket.io/socket.io.js"></script>
<body bgcolor="black">                                 
        <canvas id="gameCanvas" width="1000" height="800" tabindex="1"></canvas>
<script>
/**
 * An Astroid-like game.
 * Author: Chuck Lan
 **/
function serverLog(msg) {
   socket.emit("serverLog", {"log" : msg}); 
}
function getMousePos(canvas, evt) {
	// get canvas position
	var obj = canvas;
	var top = 0;
	var left = 0;
	while (obj && obj.tagName != 'BODY') {
		top += obj.offsetTop;
		left += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	// return relative mouse position
        var ps = PlayerSession.all[sessionId];
        var turret = ps.turret;
	turret.mousePosX = evt.clientX - left + window.pageXOffset;
	turret.mousePosY = evt.clientY - top + window.pageYOffset;
        socket.emit("mousePos", {"mousePosX" : turret.mousePosX,
                                 "mousePosY" : turret.mousePosY}); 
}
var hor = 0, ver = 0, score = 0, gameOver = 0, gamePaused=0, 
started = 0, mouseDown = 0,
endscoresend = 0;
var rockDate = new Date();
var mouseDate = new Date();
var scores = [];
var socket = connect();
var sessionId = null;
var transparency = 0.2;
function connect() {
   return io.connect('http://localhost:8125');
}
socket.on("connected", function (data) {
      debug("connected");
      var turret = new Turret(data["x"], data["y"], data["color"]);
      turret.life = data["life"];
      sessionId = data["sessionId"];
      var ps = new PlayerSession(sessionId, turret, data["timeLeft"]);
   });
socket.on("removePlayer", function (data) {
   var ps = PlayerSession.all[data["sessionId"]];
   ps.remove();
   if (data["sessionId"] == sessionId) {
      socket.disconnect();
      drawGameOver();
   }
});
socket.on("damagePlayer", function (data) {
   var ps = PlayerSession.all[data["sessionId"]];
   ps.turret.life = data["life"];
});
socket.on("readscore", function (data) {
   //debug("scores " + scores);
   if (data > 0) {
      scores.push(data);
   }
});
socket.on("createRock", function(data) {
   var rock =  Rock.deserialize(data);
   Rock.all[rock.id] = rock;
});
socket.on("resizeRock", function(data) {
   var rock = Rock.deserialize(data);
   Rock.all[rock.id] = rock;
});
socket.on("createBullet", function(data) {
   var bullet = new Bullet(data["x"], data["y"], data["r"], data["color"], data["sessionId"], data["id"]);
   bullet.vx = data["vx"];
   bullet.vy = data["vy"];   
});
socket.on("removeBullet", function(data) {
   delete Bullet.all[data["id"]];
});
socket.on("removeRock", function(data) {
   delete Rock.all[data["id"]];
});
socket.on("endscoresend", function() {
   endscoresend = 1;
});
socket.on("updateWorld", function(data) {
   var turretMoves = data["turretMoves"];
   //debug("Number of players = " + turretMoves.length);
   for (var idx in turretMoves) {
      var turretMove = turretMoves[idx];
      var sessId = turretMove["sessionId"];
      var x = turretMove["x"];
      var y = turretMove["y"];
      var color = turretMove["color"];
      var recoil = turretMove["recoil"];
      var recoilX = turretMove["recoilX"];
      var recoilY = turretMove["recoilY"];
      var mousePosX = turretMove["mousePosX"];
      var mousePosY = turretMove["mousePosY"];
      var angle = turretMove["angle"];
      var ps = PlayerSession.all[sessId];
      if (ps == null) {
         var turret = new Turret(x, y, color);
         ps = new PlayerSession(sessId, turret, turretMove["timeLeft"]);
      }
      ps.kills = turretMove["kills"];
      var turret = ps.turret;
      turret.x = x;
      turret.y = y;
      turret.color = color;
      turret.mousePosX = mousePosX;
      turret.mousePosY = mousePosY;
      turret.angle = angle;
      turret.recoil = recoil;
      turret.recoilX = recoilX;
      turret.recoilY = recoilY;
      turret.life = turretMove["life"];
   }
   drawWorld();
});
var canvas = document.getElementById("gameCanvas");
var ctx = canvas.getContext('2d');
var shootSound = new Audio("Fireball3.wav");
function resetGame() {
   var ps = PlayerSession.all[sessionId];
   ps.remove();
   socket.socket.reconnect();
}
function pauseGame() {
	if (gamePaused == 1) {
		gamePaused = 0;
	} else {
		gamePaused = 1;
	}
}
window.addEventListener('keydown', function(event) {
	switch (event.keyCode) {
	case 87: /* Up arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			ver = -1;
		break;
	case 83: /* Down arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			ver = 1;
		break;
	case 65: /* Left arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			hor = -1;
		break;
	case 68: /* Right arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			hor = 1;
		break;
	case 82: /* Restart */
		resetGame();
		break;
	case 83: /* Start */
		started = 1;
		break;	
	case 80: /* Pause/Unpause */
                if (started == 1) 
		   pauseGame();
		break;		
	}
        //if (event.preventDefault) { event.preventDefault(); }
        //if (event.stopPropagation) { event.stopPropagation(); }
        socket.emit("moveStart", {"sessionId" : sessionId,
           "hor" : hor,
           "ver" : ver});
}, true);
window.addEventListener('keyup', function(event) {
	switch (event.keyCode) {
	case 87: /* Up arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			ver = 0;
		break;
	case 83: /* Down arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			ver = 0;
		break;
	case 65: /* Left arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			hor = 0;
		break;
	case 68: /* Right arrow was pressed */
		if (gamePaused == 0 && gameOver == 0)
			hor = 0;
		break;
	}
        //if (event.preventDefault) { event.preventDefault(); }
        //if (event.stopPropagation) { event.stopPropagation(); }
        socket.emit("moveEnd", {"sessionId" : sessionId});
}, true);
function drawTurrets() {
   for (var key in PlayerSession.all) {
      if (PlayerSession.all.hasOwnProperty(key)) {
         var ps = PlayerSession.all[key];
         var isYou = (ps.sessionId == sessionId);
         var isGhost = ps.getTimeLeft() > 0;
         drawTurret(ps, isYou, isGhost);
      }
   }   
}
// Draws turret
function drawTurret(ps, isYou, isGhost) {
        var turret = ps.turret;
	// Draw base
	ctx.save();
	ctx.translate(turret.x, turret.y);
	var now = new Date(); 
	if (now - turret.date > 250) {
		if (turret.fillIdx == 0) {
			turret.fillIdx = 1;
		} else {
			turret.fillIdx = 0;
		}
		turret.date = now;		
	}
        var turretFillStyle = ["grey", turret.color];
	ctx.fillStyle = turretFillStyle[turret.fillIdx];
        ctx.strokeStyle = "black";
        if (!isYou)
           ctx.globalAlpha = transparency;
	ctx.beginPath();
        var endAngle = Math.PI * 2;
	ctx.arc(0, 0, turret.baseRadius * turret.life / 100, 0, endAngle, true);
	ctx.closePath();
	ctx.fill();
        ctx.stroke();
	ctx.restore();
	// Draw inner base
	ctx.save();
	ctx.translate(turret.x, turret.y);
	ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        if (!isYou)
           ctx.globalAlpha = transparency;
	ctx.beginPath();
	ctx.arc(0, 0, turret.baseRadius / 2, 0, endAngle, true);
	ctx.closePath();
	ctx.fill();
        ctx.stroke();
	ctx.restore();
	// Draw Gun
	ctx.save();
        
	var angle1 = turret.angle + Math.PI / 2;
	var x1 = turret.recoilX + 2.5 * Math.cos(angle1);
	var y1 = turret.recoilY + 2.5 * Math.sin(angle1);
	var x2 = x1 + turret.length * Math.cos(turret.angle);
	var y2 = y1 + turret.length * Math.sin(turret.angle);
	var angle3 = turret.angle - Math.PI / 2;
	var x3 = x2 + 5 * Math.cos(angle3);
	var y3 = y2 + 5 * Math.sin(angle3);
	var angle4 = angle3 - Math.PI / 2;
	var x4 = x3 + turret.length * Math.cos(angle4);
	var y4 = y3 + turret.length * Math.sin(angle4);
	var x5 = x4 + 2.5 * Math.cos(angle1);
	var y5 = y4 + 2.5 * Math.sin(angle1);
	ctx.lineWidth = 1;
	ctx.fillStyle = "silver";
        ctx.strokeStyle = "black";
        //if (!isYou)
           ctx.globalAlpha = 0.2;
	ctx.beginPath();
	ctx.moveTo(turret.recoilX, turret.recoilY);
	ctx.lineTo(x1, y1);
	ctx.lineTo(x2, y2);
	ctx.lineTo(x3, y3);
	ctx.lineTo(x4, y4);
	ctx.lineTo(x5, y5);
	ctx.fill();
        ctx.stroke();
	ctx.restore();
	if (turret.recoil > 0) {
		turret.recoil = turret.recoil - 1;
	}
        if (isGhost) {
  	   ctx.save();
	   ctx.font = "8pt Courier New";
	   ctx.fillStyle = "white";
           ctx.globalAlpha = .2;
	   ctx.fillText(ps.getTimeLeft(), turret.x - 14, turret.y - 14);
	   ctx.restore();    
           ctx.save();
           ctx.translate(turret.x, turret.y);
           ctx.arc(0, 0, turret.length, 0, 2 * Math.PI, false);
           ctx.fillStyle = turret.color;
           ctx.globalAlpha = 0.1;
           ctx.fill();
           ctx.restore();
        } else {
           ctx.save();
           ctx.font = "8pt Courier New";
           ctx.fillStyle = "red";
           ctx.globalAlpha = .2;
           ctx.fillText("kls: " + ps.kills, turret.x - 14, turret.y - 14);
	   ctx.restore();
        }
}
function drawLocation() {
	// Draw location
	ctx.save();
	ctx.font = "8pt Courier New";
	ctx.fillStyle = "yellow";
	ctx.fillText("Location: " + Math.round(turret.x) + ","
			+ Math.round(turret.y), 10, 20);
	ctx.restore();
}
function drawScore() {
	ctx.save();
	ctx.font = "8pt Courier New";
	ctx.fillStyle = "white";
	ctx.fillText("" + score + " destroyed" , 10, 480);
	ctx.restore();
}
function drawHelp() {
	ctx.save();
	ctx.font = "8pt Courier New";
	ctx.fillStyle = "#6495ED";
	ctx.fillText("\u2190 a, \u2192 d, \u2191 w, \u2193 s, Left Mouse Button", 235, 20);
        ctx.restore();
}
function drawGameOver() {
	ctx.save();
	ctx.font = "bold 8pt Courier New";
	ctx.fillStyle = "yellow";
	ctx.fillText("(R)estart", 220, 250);
	ctx.restore();
}
function drawGamePaused() {
	ctx.save();
	ctx.font = "bold 24pt Calibri";
	ctx.fillStyle = "#6495ED";
	ctx.fillText("(P)lay", 200, 100);
	ctx.restore();
}
function drawGameStart() {
	ctx.save();
	ctx.font = "bold 24pt Calibri";
	ctx.fillStyle = "#6495ED";
	ctx.fillText("(S)tart", 200, 100);
	ctx.restore();
}
function drawScores() {        
        ctx.save();
        ctx.font = "bold 24pt Calibri";
        ctx.fillStyle = "#6495ED";
        ctx.fillText("Top Ten Scores", 130, 100);
        ctx.restore();
        ctx.save();
        ctx.font = "12pt Courier New";
        ctx.fillStyle = "yellow";
        var inc = 10;
        //debug("scores " + scores);
        for (var idx in scores) {
           if (idx > 9) break;
           var sc = scores[idx];
           ctx.fillText("" + idx + ". " + sc, 200, 130 + inc);
           inc += 15;
        }
        ctx.restore();
        drawScoresDone = 1;
}
var drawScoresDone = 0;
function moveRocks() {
	for (var rockId in Rock.all) {
                if (Rock.all.hasOwnProperty(rockId)) {
 		   var rock = Rock.all[rockId];
		   rock.x += rock.vx;
		   rock.y += rock.vy;
		   //rockCollideTurret(rock);
		   if (rock.x <= 0 || rock.y <= 0 || rock.x % canvas.width !== rock.x
				|| rock.y % canvas.height !== rock.y) {
			   rock.remove();
		   }
                }
	}
}
function moveBullets() {
	for (var i in Bullet.all) { 
                if (Bullet.all.hasOwnProperty(i)) {
   		   var bullet = Bullet.all[i];
		   bullet.x += bullet.vx;
		   bullet.y += bullet.vy;
		   //bulletCollideRock(bullet);
		   if (bullet.x <= 0 || bullet.y <= 0
				|| bullet.x % canvas.width !== bullet.x
				|| bullet.y % canvas.height !== bullet.y) {
		      bullet.remove();
		   }
                }
	}
}
// Bullet to Rock collision
function bulletCollideRock(bullet) {
	for ( var idx in Rock.all) {
		var rock = Rock.all[idx];
		if (distance(rock.x, rock.y, bullet.x, bullet.y) <= (bullet.r + rock.r)) {			
			bullet.remove();
			if (rock.r < 20) {
				rock.remove();
				score += 1;
			} else {
				rock.r = rock.r - 5;
				rock.resize();
			}
			break;
		}
	}
}
//Rock to Turret collision
function rockCollideTurret(rock) {
	if (distance(turret.x, turret.y, rock.x, rock.y) <= (5 + rock.r)) {	
		gameOver = 1;
                scores = [];
                socket.emit('submitscore', score);
	}
}
function distance(x1, y1, x2, y2) {
	var diffx = x2 - x1;
	var diffy = y2 - y1;
	return Math.sqrt(diffx * diffx + diffy * diffy);
}
function debug(info) {
	ctx.save();
	ctx.font = "8pt Courier New";
	ctx.fillStyle = "yellow";
	ctx.fillText("Debug: " + info, 10, 20);
	ctx.restore();
}
// Constructor
function Turret(x, y, color) {
    this.x = x;
    this.y = y;
    this.length = 20;
    this.speed = 1;
    this.date = new Date();
    this.fillIdx = 0;
    this.hor = 0;
    this.ver = 0;
    this.color = color;
    this.angle = 0;
    this.baseRadius = 10;
    this.mousePosX = 250;
    this.mousePosY = 250;
    this.recoilX = 0;
    this.recoilY = 0;
    this.life = 100;
}
function PlayerSession(sessId, turret, timeLeft) {
    this.sessionId = sessId;
    this.turret = turret;
    this.moved = false;
    this.date = new Date();
    this.timeLeft = timeLeft;
    this.kills = 0;
    PlayerSession.all[this.sessionId] = this;
}
PlayerSession.all = {};
PlayerSession.prototype = {
    remove : function() {
       delete PlayerSession.all[this.sessionId];
    },
    getTimeLeft : function() {
       var t = Math.round(((this.date.getTime() + this.timeLeft - new Date().getTime())) / 1000);
       return t;
    }
};
// Constructor
function Bullet(x, y, r, color, sessionId, id) {
	this.x = x;
	this.y = y;
	this.r = r;
	this.vx = 0;
	this.vy = 0;
        this.sessionId = sessionId;
        this.color = color;
        this.id = id;
	Bullet.all[id] = this;
}
Bullet.all = {};
Bullet.draw_all = function() {
	var i = Bullet.all.length;
	for (var i in Bullet.all) {
           if (Bullet.all.hasOwnProperty(i)) {
              Bullet.all[i].draw();
           }
	}
};
Bullet.prototype = {
	draw : function() {
		ctx.save();
		ctx.translate(this.x, this.y);
		ctx.fillStyle = this.color;
                ctx.strokeStyle = "black";
		ctx.beginPath();
		ctx.arc(0, 0, this.r, 0, Math.PI * 2, true);
		ctx.closePath();
		ctx.fill();
                ctx.stroke();
		ctx.restore();
	},
	remove : function() {
                delete Bullet.all[this.id];
	}
};
function Coord(x, y) {
	this.x = x;
	this.y = y;
}
// Constructor
function Rock(x, y, r, id) {
	this.color = "white";
	this.x = x;
	this.y = y;
	this.r = r;
	this.angle = 0;
	this.vx = 0;
	this.vy = 0;
	this.jaggedNess = 10;
	this.coords = [];
	this.drawangle = 0;
	this.spinDirection = 1;
	this.numEdges = 18;
        this.id = id;
}
Rock.all = {};
Rock.deserialize = function (data) {
   var rock = new Rock(data["x"], data["y"], data["r"], data["id"]);
   rock.color = data["color"];
   rock.angle = data["angle"];
   rock.vx = data["vx"];
   rock.vy = data["vy"];
   rock.jaggedNess = data["jaggedNess"];
   rock.coords = data["coords"];
   rock.drawangle = data["drawangle"];
   rock.spinDirection = data["spinDirection"];
   rock.numEdges = data["numEdges"];
   return rock;
};
Rock.draw_all = function() {
	for (var idx in Rock.all) {
           if (Rock.all.hasOwnProperty(idx)) {
	      Rock.all[idx].draw();
           }
	}
};
Rock.prototype = {
        remove : function () {
           delete Rock.all[this.id];
        },
	draw : function() {
		ctx.save();
		ctx.translate(this.x, this.y);
		ctx.rotate(this.drawangle * Math.PI / 180);
		this.drawangle = (this.drawangle + (1 * this.spinDirection)) % 360;
		ctx.fillStyle = this.color;
                ctx.strokeStyle = "black";
		ctx.lineWidth = 1;
		ctx.beginPath();
		var isFirst = 1;
		for ( var idx in this.coords) {
			var coord = this.coords[idx];
			if (isFirst == 1) {
				ctx.moveTo(coord[0], coord[1]);
				isFirst = 0;
			} else {
				ctx.lineTo(coord[0], coord[1]);
			}
		}
		ctx.closePath();
		ctx.fill();
                ctx.stroke();
                if (this.color == "lightblue") {
                   ctx.font = "bold 12pt Courier New";
                   ctx.fillStyle = "red";
                   ctx.fillText("+", 0, 0);
                }
		ctx.restore();
	}
};
// Adding in various event handlers
canvas.addEventListener('mousemove', function(evt) {
	getMousePos(canvas, evt);
}, false);
canvas.addEventListener('mousedown', function(evt) {
	if (gamePaused == 1 || gameOver == 1) return;
	mouseDown = 1;
        socket.emit("mouseDown");
}, false);
canvas.addEventListener('mouseup', function(evt) {
   mouseDown = 0;
   socket.emit("mouseUp");
}, false);
canvas.onselectstart = function () {return false;}
//canvas.onmousedown = function() {return false;}
function drawWorld() {	
	// Clear display
	ctx.save();
	ctx.fillStyle = "rgba(0, 0, 0, .2)";
	ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle ="#6495ED";
        ctx.strokeRect(2, 2, canvas.width - 4, canvas.height - 4);
	ctx.restore();		
	moveRocks();
	// Draw turret
	drawTurrets();
        moveBullets();
        Bullet.draw_all();
	// Draw rocks
	Rock.draw_all();
	//drawScore();
	
	drawHelp();
}
</script>
</body>
</html>
